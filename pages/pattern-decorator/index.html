<!DOCTYPE HTML>
<html>
    <head>
    <meta charset="UTF-8">
    <meta name="description" content="Паттерн декоратор - это мощный паттерн проектирования, который представляет собой альтернативу наследованию. Рассмотрим применение и различные вариации паттерна">
    <title>DSSSG Blog</title>
    <link rel="shortcut icon" type="image/png" href="/imgs/favicon.png"/>
    <link href='/theme/normalize.css' rel='stylesheet' type='text/css'>
    <link href='/theme/style.css' rel='stylesheet' type='text/css'>
    </head>
    <body>
        <div id="header" class="page-header">
            <a href="/"><img alt="Cool Image" src="/imgs/logo.jpg"></a>
            <span class="tooltip">Больше статей!</span>
            <h1>Паттерн Decorator</h1>
        </div>
        <hr>
        <div id="post-body"><p>Паттерн Decorator - это структурный паттерн проектирования.
Структурные паттерны компонуют объекты вместе, чтобы получить более
гибкую архитектуру.</p>
<blockquote><p>Все рассказы серии:</p>
<ul>
<li><a href="/pages/simple-factory-factory-method-i-abstract-factory">Simple Factory, Factory Method и Abstract Factory</a></li>
<li>Decorator</li>
</ul>
</blockquote>
<h2>Мотивация использования</h2>
<p>Мы будем разбирать паттерн Decorator на примере игры, в которой главный
герой на клеточной доске сражается с монстрами.</p>
<p><img src="/imgs/board_game2.png" alt="Пример игры"></p>
<p>При этом возможно следующее:</p>
<ul>
<li>главный герой может заморозить противника, чтобы тот не смог переместиться в другую клетку</li>
<li>противник может перейти в состояние ярости, тогда наносимый им урон увеличиться</li>
</ul>
<p>Первое решение, которое может придти в голову - это для каждого конкретного
монстра в игре выделить класс, а от него отнаследовать все возвможные
классы-состояния:</p>
<p><img src="/imgs/decorator_bad_example.png" alt="Пример плохой реализации, нужен декоратор"></p>
<p>Но в будущем у нас могут добавиться новые типы монстров и новые возможности в
игре (например, отравление, воспламенение и др.). Тогда число классов, которые
нам нужно будет создавать, будет очень велико. Поддерживать такую игру будет 
сложно.</p>
<h3>Первая версия Decorator</h3>
<p><img src="/imgs/decorator_not_bad.png" alt="Паттерн декоратор, можно улучшить"></p>
<p>Что, если перенести состояния заморозки и ярости
(а они меняют функции объекта-моснтра) с каждого конкретного монстра, на всех
монстров в целом? То есть создать класс заморозки, и в его конструктор
передавать конкретного монстра, и у нас был бы замороженный монстр
(замороженный монстр является монстром, поэтому класс заморозки должен быть
отнаследован от <code>IMonster</code>).</p>
<p>Такой подход решил бы вопросы с поддерживаемостью, так как не пришлось бы для каждого
монстра порождать кучу подклассов.</p>
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%"><span></span><span style="color: #BC7A00">#include</span> <span style="color: #408080; font-style: italic">&lt;iostream&gt;</span><span style="color: #BC7A00"></span>
<span style="color: #BC7A00">#include</span> <span style="color: #408080; font-style: italic">&lt;memory&gt;</span><span style="color: #BC7A00"></span>

<span style="color: #008000; font-weight: bold">struct</span> IMonster {
    <span style="color: #008000; font-weight: bold">virtual</span> <span style="color: #B00040">void</span> move() <span style="color: #666666">=</span> <span style="color: #666666">0</span>;
    <span style="color: #008000; font-weight: bold">virtual</span> <span style="color: #B00040">void</span> <span style="color: #0000FF">attack</span>(<span style="color: #B00040">int</span> <span style="color: #666666">=</span> <span style="color: #666666">0</span>) <span style="color: #666666">=</span> <span style="color: #666666">0</span>;
    <span style="color: #008000; font-weight: bold">virtual</span> <span style="color: #666666">~</span>IMonster(){}
};

<span style="color: #008000; font-weight: bold">struct</span> <span style="color: #A0A000">Dragon</span> : IMonster {
    Dragon(<span style="color: #B00040">int</span> in_damage)<span style="color: #666666">:</span> _damage(in_damage){
        std<span style="color: #666666">::</span>cout <span style="color: #666666">&lt;&lt;</span> <span style="color: #BA2121">&quot;Создан монстр - дракон&quot;</span> <span style="color: #666666">&lt;&lt;</span> std<span style="color: #666666">::</span>endl;
    }
    <span style="color: #B00040">void</span> move(){
        std<span style="color: #666666">::</span>cout <span style="color: #666666">&lt;&lt;</span> <span style="color: #BA2121">&quot;Дракон перемещается в новую клетку&quot;</span> <span style="color: #666666">&lt;&lt;</span> std<span style="color: #666666">::</span>endl;   
    }    
    <span style="color: #B00040">void</span> attack(<span style="color: #B00040">int</span> addition <span style="color: #666666">=</span> <span style="color: #666666">0</span>){
        std<span style="color: #666666">::</span>cout <span style="color: #666666">&lt;&lt;</span> <span style="color: #BA2121">&quot;Дракон нападает, получен урон - &quot;</span> <span style="color: #666666">&lt;&lt;</span> _damage <span style="color: #666666">+</span> addition
                  <span style="color: #666666">&lt;&lt;</span> <span style="color: #BA2121">&quot; единиц&quot;</span> <span style="color: #666666">&lt;&lt;</span> std<span style="color: #666666">::</span>endl;
    }
    <span style="color: #008000; font-weight: bold">const</span> <span style="color: #B00040">int</span> _damage;
};

<span style="color: #008000; font-weight: bold">struct</span> <span style="color: #A0A000">IceIMonsterDecorator</span> : IMonster {
    IceIMonsterDecorator(std<span style="color: #666666">::</span>unique_ptr<span style="color: #666666">&lt;</span>IMonster<span style="color: #666666">&gt;</span> in_monster)
    <span style="color: #666666">:</span>_monster(std<span style="color: #666666">::</span>move(in_monster)){}
    <span style="color: #B00040">void</span> move(){
        std<span style="color: #666666">::</span>cout <span style="color: #666666">&lt;&lt;</span> <span style="color: #BA2121">&quot;Заморожен в лед и не может переместиться&quot;</span> <span style="color: #666666">&lt;&lt;</span> std<span style="color: #666666">::</span>endl;
    }
    <span style="color: #B00040">void</span> attack(<span style="color: #B00040">int</span> addition <span style="color: #666666">=</span> <span style="color: #666666">0</span>){
        _monster<span style="color: #666666">-&gt;</span>attack(addition);
    }
    <span style="color: #008000; font-weight: bold">private</span><span style="color: #666666">:</span>
    std<span style="color: #666666">::</span>unique_ptr<span style="color: #666666">&lt;</span>IMonster<span style="color: #666666">&gt;</span> _monster;
};

<span style="color: #008000; font-weight: bold">struct</span> <span style="color: #A0A000">InRageIMonsterDecorator</span> : IMonster {
    InRageIMonsterDecorator(std<span style="color: #666666">::</span>unique_ptr<span style="color: #666666">&lt;</span>IMonster<span style="color: #666666">&gt;</span> in_monster)
    <span style="color: #666666">:</span>_monster(std<span style="color: #666666">::</span>move(in_monster)){}
    <span style="color: #B00040">void</span> move(){
        _monster<span style="color: #666666">-&gt;</span>move();
    }
    <span style="color: #B00040">void</span> attack(<span style="color: #B00040">int</span> addition <span style="color: #666666">=</span> <span style="color: #666666">0</span>){
        std<span style="color: #666666">::</span>cout <span style="color: #666666">&lt;&lt;</span> <span style="color: #BA2121">&quot;Приведен в ярость, будет атаковать на 5 единиц мощнее&quot;</span>
                  <span style="color: #666666">&lt;&lt;</span> std<span style="color: #666666">::</span>endl;
        _monster<span style="color: #666666">-&gt;</span>attack(addition <span style="color: #666666">+</span> <span style="color: #666666">5</span>);
    }
    <span style="color: #008000; font-weight: bold">private</span><span style="color: #666666">:</span>
    std<span style="color: #666666">::</span>unique_ptr<span style="color: #666666">&lt;</span>IMonster<span style="color: #666666">&gt;</span> _monster;
};

<span style="color: #B00040">int</span> <span style="color: #0000FF">main</span>(){
    std<span style="color: #666666">::</span>unique_ptr<span style="color: #666666">&lt;</span>IMonster<span style="color: #666666">&gt;</span> monster <span style="color: #666666">=</span> std<span style="color: #666666">::</span>make_unique<span style="color: #666666">&lt;</span>IceIMonsterDecorator<span style="color: #666666">&gt;</span>(
        std<span style="color: #666666">::</span>make_unique<span style="color: #666666">&lt;</span>InRageIMonsterDecorator<span style="color: #666666">&gt;</span>(
            std<span style="color: #666666">::</span>make_unique<span style="color: #666666">&lt;</span>Dragon<span style="color: #666666">&gt;</span>(<span style="color: #666666">25</span>)
        )
    );
    monster<span style="color: #666666">-&gt;</span>move();
    monster<span style="color: #666666">-&gt;</span>attack();

    <span style="color: #008000; font-weight: bold">return</span> <span style="color: #666666">0</span>;
}
</pre></div>
<p>Вывод программы:</p>
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%"><span></span>Создан монстр - дракон
Заморожен в лед и не может переместиться
Приведен в ярость, будет атаковать на <span style="color: #666666">5</span> единиц мощнее
Дракон нападает, получен урон - <span style="color: #666666">30</span> единиц
</pre></div>
<p>Но и у этой реализации есть минусы. Декоратор ведь не обязан изменять
функциональность всех методов <code>IMonster</code>. Тогда в методах, которые он не
изменяет, идет простое перенаправление вызовов к своему внутреннему объекту.</p>
<p>Только у нас в примере <code>IMonster</code> имеет всего два метода, но если бы их было 
много, тогда в каждом классе-декораторе содержалось бы много одинаковых методов
перенаправителей. Это было бы дублированием кода, а где дублирование, там и
ошибки.</p>
<h3>Вторая версия Decorator</h3>
<p>Проблема выше решается введением общего класса <code>IMonsterDecorator</code>.</p>
<p><img src="/imgs/decorator_good.png" alt="Паттерн декоратор"></p>
<p>Теперь классы-декораторы могут переопределять только те методы, которые им
нужны, для изменения функциональности объекта.</p>
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%"><span></span><span style="color: #BC7A00">#include</span> <span style="color: #408080; font-style: italic">&lt;iostream&gt;</span><span style="color: #BC7A00"></span>
<span style="color: #BC7A00">#include</span> <span style="color: #408080; font-style: italic">&lt;memory&gt;</span><span style="color: #BC7A00"></span>

<span style="color: #008000; font-weight: bold">struct</span> IMonster {
    <span style="color: #008000; font-weight: bold">virtual</span> <span style="color: #B00040">void</span> move() <span style="color: #666666">=</span> <span style="color: #666666">0</span>;
    <span style="color: #008000; font-weight: bold">virtual</span> <span style="color: #B00040">void</span> <span style="color: #0000FF">attack</span>(<span style="color: #B00040">int</span> <span style="color: #666666">=</span> <span style="color: #666666">0</span>) <span style="color: #666666">=</span> <span style="color: #666666">0</span>;
    <span style="color: #008000; font-weight: bold">virtual</span> <span style="color: #666666">~</span>IMonster(){}
};

<span style="color: #008000; font-weight: bold">struct</span> <span style="color: #A0A000">Dragon</span> : IMonster {
    Dragon(<span style="color: #B00040">int</span> in_damage)<span style="color: #666666">:</span> _damage(in_damage){
        std<span style="color: #666666">::</span>cout <span style="color: #666666">&lt;&lt;</span> <span style="color: #BA2121">&quot;Создан монстр - дракон&quot;</span> <span style="color: #666666">&lt;&lt;</span> std<span style="color: #666666">::</span>endl;
    }
    <span style="color: #B00040">void</span> move(){
        std<span style="color: #666666">::</span>cout <span style="color: #666666">&lt;&lt;</span> <span style="color: #BA2121">&quot;Дракон перемещается в новую клетку&quot;</span> <span style="color: #666666">&lt;&lt;</span> std<span style="color: #666666">::</span>endl;   
    }    
    <span style="color: #B00040">void</span> attack(<span style="color: #B00040">int</span> addition <span style="color: #666666">=</span> <span style="color: #666666">0</span>){
        std<span style="color: #666666">::</span>cout <span style="color: #666666">&lt;&lt;</span> <span style="color: #BA2121">&quot;Дракон нападает, получен урон - &quot;</span> <span style="color: #666666">&lt;&lt;</span> _damage <span style="color: #666666">+</span> addition
                  <span style="color: #666666">&lt;&lt;</span> <span style="color: #BA2121">&quot; единиц&quot;</span> <span style="color: #666666">&lt;&lt;</span> std<span style="color: #666666">::</span>endl;
    }
    <span style="color: #008000; font-weight: bold">const</span> <span style="color: #B00040">int</span> _damage;
};

<span style="color: #008000; font-weight: bold">struct</span> <span style="color: #A0A000">IMonsterDecorator</span> : IMonster {
    IMonsterDecorator(std<span style="color: #666666">::</span>unique_ptr<span style="color: #666666">&lt;</span>IMonster<span style="color: #666666">&gt;</span> in_monster)
    <span style="color: #666666">:</span>_monster(std<span style="color: #666666">::</span>move(in_monster)){}
    <span style="color: #B00040">void</span> move(){
        _monster<span style="color: #666666">-&gt;</span>move();
    }
    <span style="color: #B00040">void</span> attack(<span style="color: #B00040">int</span> addition <span style="color: #666666">=</span> <span style="color: #666666">0</span>){
        _monster<span style="color: #666666">-&gt;</span>attack(addition);
    }    
    <span style="color: #008000; font-weight: bold">private</span><span style="color: #666666">:</span>
    std<span style="color: #666666">::</span>unique_ptr<span style="color: #666666">&lt;</span>IMonster<span style="color: #666666">&gt;</span> _monster;
};

<span style="color: #008000; font-weight: bold">struct</span> <span style="color: #A0A000">IceIMonsterDecorator</span> : IMonsterDecorator {
    IceIMonsterDecorator(std<span style="color: #666666">::</span>unique_ptr<span style="color: #666666">&lt;</span>IMonster<span style="color: #666666">&gt;</span> in_monster)
    <span style="color: #666666">:</span>IMonsterDecorator(std<span style="color: #666666">::</span>move(in_monster)){}
    <span style="color: #B00040">void</span> move(){
        std<span style="color: #666666">::</span>cout <span style="color: #666666">&lt;&lt;</span> <span style="color: #BA2121">&quot;Заморожен в лед и не может переместиться&quot;</span> <span style="color: #666666">&lt;&lt;</span> std<span style="color: #666666">::</span>endl;
    }
};

<span style="color: #008000; font-weight: bold">struct</span> <span style="color: #A0A000">InRageIMonsterDecorator</span> : IMonsterDecorator {
    InRageIMonsterDecorator(std<span style="color: #666666">::</span>unique_ptr<span style="color: #666666">&lt;</span>IMonster<span style="color: #666666">&gt;</span> in_monster)
    <span style="color: #666666">:</span>IMonsterDecorator(std<span style="color: #666666">::</span>move(in_monster)){}
    <span style="color: #B00040">void</span> attack(<span style="color: #B00040">int</span> addition <span style="color: #666666">=</span> <span style="color: #666666">0</span>){
        std<span style="color: #666666">::</span>cout <span style="color: #666666">&lt;&lt;</span> <span style="color: #BA2121">&quot;Приведен в ярость, будет атаковать на 5 единиц мощнее&quot;</span>
                  <span style="color: #666666">&lt;&lt;</span> std<span style="color: #666666">::</span>endl;
        IMonsterDecorator<span style="color: #666666">::</span>attack(addition<span style="color: #666666">+5</span>);
    }
};

<span style="color: #B00040">int</span> <span style="color: #0000FF">main</span>(){
    std<span style="color: #666666">::</span>unique_ptr<span style="color: #666666">&lt;</span>IMonster<span style="color: #666666">&gt;</span> monster <span style="color: #666666">=</span> std<span style="color: #666666">::</span>make_unique<span style="color: #666666">&lt;</span>IceIMonsterDecorator<span style="color: #666666">&gt;</span>(
        std<span style="color: #666666">::</span>make_unique<span style="color: #666666">&lt;</span>InRageIMonsterDecorator<span style="color: #666666">&gt;</span>(
            std<span style="color: #666666">::</span>make_unique<span style="color: #666666">&lt;</span>Dragon<span style="color: #666666">&gt;</span>(<span style="color: #666666">25</span>)
        )
    );
    monster<span style="color: #666666">-&gt;</span>move();
    monster<span style="color: #666666">-&gt;</span>attack();

    <span style="color: #008000; font-weight: bold">return</span> <span style="color: #666666">0</span>;
}
</pre></div>
<h3>Выводы по паттерну Decorator</h3>
<p><strong>Паттерн Decorator</strong> может использован там, где нужно прямо во время работы
программы навешивать на объект новый функционал.</p>
<p>В нашем примере замороженный дракон не мог переместиться в другую
клетку - мы наделили объект этой функцией уже после его создания, обернув его в
<code>IceIMonsterDecorator</code>.</p>
</div>
        <hr>
        <div id="footer">
            <div id="menu">
                <a href="#">Twitter</a>
                <a href="#">Facebook</a>
                <a href="#">Github</a>
            </div>
        </div>
    </body>
</html>